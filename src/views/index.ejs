<%- include('partials/header', { title: 'Actual Auto Categorise' }) %>
  <div class="container py-5">
    <h1 class="mb-4 text-center">Actual Auto Categorise</h1>
    <div class="d-flex justify-content-center gap-3">
      <button id="trainBtn" class="btn btn-primary btn-lg">Train</button>
      <button id="classifyBtn" class="btn btn-success btn-lg">Classify</button>
      <% if (showLogoutButton) { %>
        <form method="POST" action="/auth/logout" class="m-0">
          <button type="submit" class="btn btn-outline-secondary btn-lg">Logout</button>
        </form>
      <% } %>
    </div>
    <div id="status" class="mt-4 text-center"></div>
  </div>
  <script>
    const statusEl = document.getElementById('status');

    const basePath = (() => {
      const path = window.location.pathname;
      if (path.endsWith('/')) return path;
      const trimmed = path.replace(/\/[^/]*$/, '/');
      return trimmed.endsWith('/') ? trimmed : `${trimmed}/`;
    })();

    function buildUrl(endpoint) {
      const relative = endpoint.replace(/^\//, '');
      return `${basePath}${relative}`;
    }

    async function triggerAction(endpoint, pendingText) {
      statusEl.textContent = pendingText;
      try {
        const response = await fetch(buildUrl(endpoint), { method: 'POST' });
        const contentType = response.headers.get('content-type') || '';
        const body = await response.text();
        let payload = null;

        if (body && contentType.includes('application/json')) {
          try {
            payload = JSON.parse(body);
          } catch (parseErr) {
            // Fall back to showing the raw body below.
          }
        }

        if (!response.ok) {
          const message =
            (payload && (payload.message || payload.error)) ||
            (body && body.trim()) ||
            response.statusText ||
            'Request failed';
          throw new Error(message);
        }

        if (payload) {
          statusEl.textContent = payload.message || JSON.stringify(payload);
        } else {
          statusEl.textContent = body || 'Done.';
        }
      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || err);
      }
    }

    document.getElementById('trainBtn').onclick = () =>
      triggerAction('train', 'Training started...');
    document.getElementById('classifyBtn').onclick = () =>
      triggerAction('classify', 'Classification started...');
  </script>
<%- include('partials/footer') %>
