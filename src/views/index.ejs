<%- include('partials/header', { title: 'Actual Auto Categorise' }) %>
  <div class="container py-5">
    <h1 class="mb-4 text-center">Actual Auto Categorise</h1>
    <div class="d-flex justify-content-center gap-3">
      <button id="trainBtn" class="btn btn-primary btn-lg">Train</button>
      <button id="classifyBtn" class="btn btn-success btn-lg">Classify</button>
      <% if (showLogoutButton) { %>
        <form method="POST" action="/auth/logout" class="m-0">
          <button type="submit" class="btn btn-outline-secondary btn-lg">Logout</button>
        </form>
      <% } %>
    </div>
    <div id="status" class="mt-4 text-center"></div>
  </div>
  <script>
    const statusEl = document.getElementById('status');

    const basePath = (() => {
      const path = window.location.pathname;
      if (path.endsWith('/')) return path;
      const trimmed = path.replace(/\/[^/]*$/, '/');
      return trimmed.endsWith('/') ? trimmed : `${trimmed}/`;
    })();

    function buildUrl(endpoint) {
      const relative = endpoint.replace(/^\//, '');
      return `${basePath}${relative}`;
    }

    let trainPollTimeout = null;

    function stopTrainPolling() {
      if (trainPollTimeout) {
        clearTimeout(trainPollTimeout);
        trainPollTimeout = null;
      }
    }

    function renderTrainStatus(status) {
      if (!status) return;
      let text = status.message || `Training ${status.state}`;
      if (status.startedAt && status.state === 'running') {
        try {
          const ts = new Date(status.startedAt);
          text += ` (started ${ts.toLocaleTimeString()})`;
        } catch (_) {
          // ignore parsing issues
        }
      }
      if (status.error) {
        text += ` â€” ${status.error}`;
      }
      statusEl.textContent = text;
    }

    async function fetchTrainStatus() {
      const res = await fetch(buildUrl('train/status'));
      if (!res.ok) {
        throw new Error('Failed to fetch training status');
      }
      return res.json();
    }

    async function refreshTrainStatus(scheduleNext = false) {
      try {
        const data = await fetchTrainStatus();
        if (data?.status) {
          renderTrainStatus(data.status);
          if (scheduleNext && data.status.state === 'running') {
            trainPollTimeout = setTimeout(() => refreshTrainStatus(true), 5000);
            return;
          }
        }
        if (!scheduleNext) {
          return;
        }
        stopTrainPolling();
      } catch (err) {
        statusEl.textContent =
          'Error fetching training status: ' + (err.message || err);
        if (scheduleNext) {
          trainPollTimeout = setTimeout(() => refreshTrainStatus(true), 5000);
        }
      }
    }

    function beginTrainMonitoring() {
      stopTrainPolling();
      refreshTrainStatus(true);
    }

    async function triggerAction(endpoint, pendingText) {
      statusEl.textContent = pendingText;
      try {
        const response = await fetch(buildUrl(endpoint), { method: 'POST' });
        const contentType = response.headers.get('content-type') || '';
        const body = await response.text();
        let payload = null;

        if (body && contentType.includes('application/json')) {
          try {
            payload = JSON.parse(body);
          } catch (parseErr) {
            // Fall back to showing the raw body below.
          }
        }

        if (!response.ok) {
          const message =
            (payload && (payload.message || payload.error)) ||
            (body && body.trim()) ||
            response.statusText ||
            'Request failed';
          throw new Error(message);
        }

        if (endpoint === 'train' && payload?.status) {
          renderTrainStatus(payload.status);
          if (payload.status.state === 'running') {
            beginTrainMonitoring();
          } else {
            stopTrainPolling();
          }
        } else if (payload) {
          statusEl.textContent = payload.message || JSON.stringify(payload);
        } else {
          statusEl.textContent = body || 'Done.';
        }
      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || err);
      }
    }

    document.getElementById('trainBtn').onclick = () =>
      triggerAction('train', 'Training started...');
    document.getElementById('classifyBtn').onclick = () =>
      triggerAction('classify', 'Classification started...');

    refreshTrainStatus(false);
  </script>
<%- include('partials/footer') %>
